services:
  clickhouse:
    image: clickhouse/clickhouse-server:latest
    volumes:
      - clickhouse-data:/var/lib/clickhouse
      - ./clickhouse-config.xml:/etc/clickhouse-server/config.d/clickhouse-config.xml
    environment:
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  metabase:
    image: metabase/metabase-enterprise:latest
    environment:
      - MB_DB_TYPE=h2
      - MB_PLUGINS_DIR=/plugins
      - MB_DB_FILE=/data/metabase.db
      - MB_ENABLE_EMBEDDING=true
      - MB_ADMIN_EMAIL=admin@example.com
      - MB_ADMIN_PASSWORD=${METABASE_ADMIN_PASSWORD}
    volumes:
      - metabase-data:/data
      - ./plugins:/plugins
      - /data/experiments:/experiments
    depends_on:
      clickhouse:
        condition: service_healthy
    restart: unless-stopped

  tabix:
    image: spoonest/clickhouse-tabix-web-client:latest
    restart: unless-stopped

  dagit:
    build: .
    image: trades-warehouse-dagster:latest
    environment:
      - DAGSTER_HOME=/opt/trades-warehouse
      - PYTHONPATH=/opt/trades-warehouse
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    volumes:
      - .:/opt/trades-warehouse
      - dagster-instance:/opt/dagster-instance
    depends_on:
      clickhouse:
        condition: service_healthy
    command: dagit -h 0.0.0.0 -p 3000
    restart: unless-stopped

  dagster:
    build: .
    image: trades-warehouse-dagster:latest
    environment:
      - DAGSTER_HOME=/opt/trades-warehouse
      - PYTHONPATH=/opt/trades-warehouse
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
    volumes:
      - .:/opt/trades-warehouse
      - dagster-instance:/opt/dagster-instance
    depends_on:
      clickhouse:
        condition: service_healthy
    command: dagster-daemon run
    restart: unless-stopped

  jupyter:
    build: .
    image: trades-warehouse-dagster:latest
    working_dir: /opt/notebooks
    environment:
      - PYTHONPATH=/opt/trades-warehouse
      - CLICKHOUSE_PASSWORD=${CLICKHOUSE_PASSWORD}
      - JUPYTER_TOKEN=${JUPYTER_TOKEN}
    volumes:
      - .:/opt/trades-warehouse
      - dagster-instance:/opt/dagster-instance
      - /data/notebooks:/opt/notebooks
      - /data/experiments:/opt/experiments
    depends_on:
      clickhouse:
        condition: service_healthy
    command: >
      bash -lc "jupyter lab --ip=0.0.0.0 --no-browser --allow-root \
      --IdentityProvider.token='${JUPYTER_TOKEN}' \
      --ServerApp.allow_origin='*'"
    restart: unless-stopped

  nginx:
    image: nginx:latest
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    depends_on:
      - clickhouse
      - metabase
      - tabix
      - dagit
      - jupyter
    command: '/bin/sh -c ''while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''
    restart: unless-stopped

  certbot:
    image: certbot/certbot
    volumes:
      - ./data/certbot/conf:/etc/letsencrypt
      - ./data/certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done; '"

volumes:
  clickhouse-data:
  metabase-data:
  grafana-data:
  dagster-instance:
