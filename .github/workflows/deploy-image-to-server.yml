name: Deploy Image To Server

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Deploy Image to Registry"]
    types:
      - completed

permissions:
  contents: read
  packages: read

jobs:
  deploy-image-to-server:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Convert repository name to lowercase
        id: repo_name
        run: |
          echo "REPO_LC=${GITHUB_REPOSITORY,,}" >> ${GITHUB_ENV}

      - name: Create .env file
        run: |
          echo "CLICKHOUSE_PASSWORD=${{ secrets.CLICKHOUSE_PASSWORD }}" >> .env
          echo "JUPYTER_TOKEN=${{ secrets.JUPYTER_TOKEN }}" >> .env
          echo "METABASE_ADMIN_PASSWORD=${{ secrets.METABASE_ADMIN_PASSWORD }}" >> .env

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.TDW_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan 37.27.112.167 >> ~/.ssh/known_hosts

      - name: Prepare Server Directory
        run: ssh root@37.27.112.167 "mkdir -p /opt/tdw-control-plane/"

      - name: Deploy .env to Server
        run: |
          scp .env root@37.27.112.167:/opt/tdw-control-plane/.env

      - name: Deploy Image To Server
        env:
          IMAGE_TAG: ghcr.io/${{ env.REPO_LC }}:latest
        run: |
          # Log in to GHCR on the remote server
          echo "${{ secrets.GITHUB_TOKEN }}" | ssh root@37.27.112.167 "docker login ghcr.io -u ${{ github.actor }} --password-stdin"

          # Deploy
          ssh root@37.27.112.167 << EOF
            echo "ðŸš€ Starting deployment process..."
            cd /opt/tdw-control-plane && \
            git checkout main && \
            git pull && \
            docker pull ${IMAGE_TAG} && \
            docker tag ${IMAGE_TAG} trades-warehouse-dagster:latest && \
            docker-compose down && \
            docker-compose up -d --no-build && \
            echo "âœ… Deployment complete!"
          EOF
